<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2-Bar Visual Rhythm Generator</title>
    <link rel="stylesheet" href="styles-2.css">
    <style>
        #back {
            width: 100%;
            box-sizing: border-box;
            padding-top: 20px;
            padding-left: 20px;
            text-align: left;
        }

        .bar {
            margin-bottom: 20px;
            margin-left: 10px;
            padding: 10px;
            border: 2px solid;
            border-radius: 5px;
            display: inline-block;
        }

        .note {
            display: inline-block;
            height: 60px;
            line-height: 60px;
            margin: 1px;
            border: 1px solid;
            border-radius: 5px;
            font-size: 18px;
            text-align: center;
            overflow: hidden;
            background-color: rgb(51, 48, 48);
        }
    </style>
</head>

<body>
    <div id="back">
        <a href="../index.html">[back]</a>
    </div>
    <h2>2-Bar Visual Rhythm Generator</h1>
        <button onclick="generateRhythm()">Generate Rhythm</button>
        <button onclick="resetCheckboxes()">Reset to (2,4,8)</button>

        <div class="options" style="margin-top: 10px;">
            <label>
                <input type="checkbox" id="wholeNoteCheckbox">(1)
            </label>
            <label>
                <input type="checkbox" id="halfNoteCheckbox" checked>(2)
            </label>
            <label>
                <input type="checkbox" id="quarterNoteCheckbox" checked>(4)
            </label>
            <label>
                <input type="checkbox" id="eighthNoteCheckbox" checked>(8)
            </label>
            <label>
                <input type="checkbox" id="sixteenthNoteCheckbox">(16)
            </label>
        </div>

        <div id="rhythmDisplay" style="margin-top: 20px;"></div>

        <script>
            // Constants
            const beatsPerBar = 4; // 4/4 time signature
            const totalBars = 2; // 2 bars
            const totalBeats = beatsPerBar * totalBars; // Total beats in 2 bars
            const baseWidth = 120; // Width in pixels for a whole note

            // All possible note lengths
            const allNoteLengths = [
                { name: "1", value: 4 },    // Whole note
                { name: "2", value: 2 },    // Half note
                { name: "4", value: 1 },    // Quarter note
                { name: "8", value: 0.5 },  // Eighth note
                { name: "", value: 0.25 }   // Sixteenth note
            ];

            // Load saved checkbox states or set defaults
            function loadCheckboxStates() {
                const defaultStates = {
                    wholeNoteCheckbox: false,
                    halfNoteCheckbox: true,
                    quarterNoteCheckbox: true,
                    eighthNoteCheckbox: true,
                    sixteenthNoteCheckbox: false
                };

                for (let id in defaultStates) {
                    const savedState = localStorage.getItem(id);
                    document.getElementById(id).checked = savedState !== null ? JSON.parse(savedState) : defaultStates[id];
                }
            }

            // Save checkbox states
            function saveCheckboxStates() {
                const checkboxIds = [
                    'wholeNoteCheckbox',
                    'halfNoteCheckbox',
                    'quarterNoteCheckbox',
                    'eighthNoteCheckbox',
                    'sixteenthNoteCheckbox'
                ];
                checkboxIds.forEach(id => {
                    localStorage.setItem(id, document.getElementById(id).checked);
                });
            }

            // Reset to default (2, 4, 8 selected)
            function resetCheckboxes() {
                document.getElementById('wholeNoteCheckbox').checked = false;
                document.getElementById('halfNoteCheckbox').checked = true;
                document.getElementById('quarterNoteCheckbox').checked = true;
                document.getElementById('eighthNoteCheckbox').checked = true;
                document.getElementById('sixteenthNoteCheckbox').checked = false;
                saveCheckboxStates();
            }

            // Add event listeners to save changes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', saveCheckboxStates);
            });

            // Load initial states on page load
            window.onload = loadCheckboxStates;

            // Function to generate a random rhythm
            function generateRhythm() {
                const rhythmDisplay = document.getElementById('rhythmDisplay');
                rhythmDisplay.innerHTML = ''; // Clear previous rhythm

                // Get selected note lengths
                const availableNoteLengths = allNoteLengths.filter(note => {
                    if (note.name === "1") return document.getElementById('wholeNoteCheckbox').checked;
                    if (note.name === "2") return document.getElementById('halfNoteCheckbox').checked;
                    if (note.name === "4") return document.getElementById('quarterNoteCheckbox').checked;
                    if (note.name === "8") return document.getElementById('eighthNoteCheckbox').checked;
                    if (note.name === "") return document.getElementById('sixteenthNoteCheckbox').checked;
                });

                // If no notes are selected, use defaults (2, 4, 8)
                if (availableNoteLengths.length === 0) {
                    availableNoteLengths.push(
                        { name: "2", value: 2 },
                        { name: "4", value: 1 },
                        { name: "8", value: 0.5 }
                    );
                }

                // Create a container for each bar
                for (let bar = 0; bar < totalBars; bar++) {
                    const barContainer = document.createElement('div');
                    barContainer.className = 'bar';
                    rhythmDisplay.appendChild(barContainer);

                    let barBeats = 0;
                    let lastNoteType = null;
                    let consecutiveCount = 0;

                    while (barBeats < beatsPerBar) {
                        let randomNote;

                        // Apply Markov chain logic
                        if (lastNoteType === "4" && consecutiveCount === 1) {
                            if (Math.random() < 0.1) {
                                console.log("Repeating 4th note");
                                randomNote = availableNoteLengths.find(note => note.name === "4");
                            } else {
                                randomNote = getRandomNote(availableNoteLengths, "4");
                            }
                        } else if (lastNoteType === "8" && consecutiveCount < 4) {
                            if (Math.random() < 0.5) {
                                console.log("Repeating 8th note");
                                randomNote = availableNoteLengths.find(note => note.name === "8");
                            } else {
                                randomNote = getRandomNote(availableNoteLengths, "8");
                            }
                        } else if (lastNoteType === "" && consecutiveCount < 2) {
                            if (Math.random() < 0.8) {
                                console.log("Repeating 16th note");
                                randomNote = availableNoteLengths.find(note => note.name === "");
                            } else {
                                randomNote = getRandomNote(availableNoteLengths, "");
                            }
                        } else {
                            randomNote = availableNoteLengths[Math.floor(Math.random() * availableNoteLengths.length)];
                        }

                        // Ensure the note fits and exists
                        if (randomNote && randomNote.value <= (beatsPerBar - barBeats)) {
                            const noteElement = document.createElement('div');
                            noteElement.className = 'note';
                            noteElement.textContent = randomNote.name;

                            const noteWidth = (randomNote.value / 4) * baseWidth;
                            noteElement.style.width = `${noteWidth}px`;

                            if (randomNote.value <= 0.5) {
                                noteElement.style.fontSize = "14px";
                            }

                            barContainer.appendChild(noteElement);
                            barBeats += randomNote.value;

                            if (randomNote.name === lastNoteType) {
                                consecutiveCount++;
                            } else {
                                lastNoteType = randomNote.name;
                                consecutiveCount = 1;
                            }

                            if ((lastNoteType === "8" && consecutiveCount === 4) || (lastNoteType === "" && consecutiveCount === 2)) {
                                console.log("Resetting consecutive count");
                                consecutiveCount = 0;
                            }
                        }
                    }
                }
            }

            // Helper function to get a random note, excluding a specific type
            function getRandomNote(availableNoteLengths, excludeType) {
                const filteredNotes = availableNoteLengths.filter(note => note.name !== excludeType);
                return filteredNotes[Math.floor(Math.random() * filteredNotes.length)];
            }
        </script>
</body>

</html>